# ðŸ“¦ Dependency Setup Instructions

## Overview
This document outlines the dual lockfile setup and monorepo dependency management for optimal CI/CD performance.

## Current Status
- âœ… **Node.js Version**: Pinned to 20.11.1 across all package.json files
- âœ… **Package Manager**: Configured for npm-only workflow  
- âœ… **Memory Optimization**: Added NODE_OPTIONS flags to all GitHub workflows
- âœ… **ESLint Fix**: Added minimatch override to resolve import/no-extraneous-dependencies error
- âœ… **Dual Lockfiles**: Root uses npm-shrinkwrap.json, backend uses package-lock.json
- âœ… **Monorepo Scripts**: install:all, lint, typecheck, backend:lint, backend:typecheck

## Lockfile Policy

### Root (Expo App) - npm-shrinkwrap.json
- **File**: `npm-shrinkwrap.json` (generated by `npm shrinkwrap`)
- **Purpose**: Locks all dependencies for the React Native/Expo app
- **Regeneration**: Run `npm shrinkwrap` after any dependency changes
- **CI Usage**: `npm ci` automatically uses npm-shrinkwrap.json when present

### Backend (Node.js/Express) - package-lock.json  
- **File**: `backend/package-lock.json` (generated by `npm install`)
- **Purpose**: Locks backend-specific dependencies
- **Regeneration**: Standard `npm install` in backend directory
- **CI Usage**: `npm ci` in backend directory

## Required Steps

### 1. Install Root Dependencies & Generate Shrinkwrap
```bash
cd /workspaces/jars-cannabis-mobile-app
NODE_OPTIONS="--max-old-space-size=6144" npm install --legacy-peer-deps
npm shrinkwrap  # Generates npm-shrinkwrap.json
```

### 2. Install Backend Dependencies  
```bash
cd backend
NODE_OPTIONS="--max-old-space-size=4096" npm install --legacy-peer-deps
# This automatically updates package-lock.json
```

### 3. Use Monorepo Helper Scripts
```bash
# Install all dependencies (root + backend)
npm run install:all

# Lint entire monorepo
npm run lint
npm run backend:lint

# Typecheck entire monorepo  
npm run typecheck
npm run backend:typecheck
```
After successful installation, verify all systems work:

```bash
# ESLint (should resolve original minimatch error)
npm run lint

# TypeScript compilation
npm run typecheck

# Unit tests
npm run test:ci

# Code formatting
npm run format:ci

# Backend checks
cd backend
npm run typecheck
npm run test:ci
```

### 6. Upgrade Expo Web Dependencies (Optional)
```bash
# Upgrade vulnerable Expo Web dependencies
npm run upgrade:expo-web
```

### 7. Commit Generated Lockfiles
```bash
git add package-lock.json backend/package-lock.json functions/package-lock.json apps/demo-web/package-lock.json
git commit -m "Add generated package-lock.json files for deterministic builds

- Ensures CI doesn't need to resolve peer dependencies from scratch
- Prevents memory exhaustion during dependency resolution in CI
- Locks all package versions for reproducible builds across environments"
```

## Troubleshooting

### Memory Errors
If you encounter memory errors during installation:
- Increase NODE_OPTIONS to `--max-old-space-size=8192` 
- Close other applications to free system memory
- Use `npm ci` instead of `npm install` after lockfiles are generated

### Peer Dependency Conflicts  
- Use `--legacy-peer-deps` flag for React Native compatibility
- The minimatch override should resolve ESLint plugin conflicts
- If issues persist, check the overrides section in package.json

### CI Failures
After completing local setup:
- Push the lockfiles to trigger CI builds
- Monitor GitHub Actions for memory-related failures  
- The NODE_OPTIONS flags should prevent most memory issues

## Expected Outcomes

After completing these steps:
1. **ESLint**: Original `(0, _minimatch2.default) is not a function` error should be resolved
2. **CI Stability**: GitHub Actions should complete without memory exhaustion
3. **Expo/Android**: E2E tests should have proper dependencies for emulator setup
4. **Deterministic Builds**: Lockfiles ensure consistent dependency resolution
5. **Web Build**: Modern `expo export:web` command replaces deprecated `expo build:web`
6. **Firebase Integration**: Backend tests can access Firebase Admin services in CI

## Firebase Admin Setup

For production deployment and full backend functionality:

1. **GitHub Secrets**: Add these to repository settings â†’ Secrets and variables â†’ Actions:
   - `FIREBASE_SERVICE_ACCOUNT_BASE64`: Base64-encoded Firebase service account JSON
   - `FIREBASE_PROJECT_ID`: Your Firebase project ID

2. **Local Development**: 
   ```bash
   cd backend
   cp .env.example .env
   # Add your Firebase credentials to .env
   ```

3. **Service Account JSON**: 
   ```bash
   # Convert your service account JSON to base64:
   cat path/to/service-account.json | base64 -w 0
   ```

## Quality Gate Verification

All of these must pass before considering the setup complete:
- [ ] `npm run lint` (no ESLint errors)
- [ ] `npm run typecheck` (TypeScript compilation succeeds)  
- [ ] `npm run test:ci` (unit tests pass)
- [ ] `npm run format:ci` (code formatting consistent)
- [ ] Backend tests pass (if configured)
- [ ] GitHub Actions workflows complete successfully